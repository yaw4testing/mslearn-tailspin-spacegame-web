steps:
  - checkout: self
    clean: true
    persistCredentials: true

  - bash: |
      set -e
      gem install cfn-nag
      cfn_templates=$(find . \( -name '*.yaml' -or -name '*.yml' \) -not -path '*/cicd/*' -exec grep -H AWSTemplateFormatVersion {} \; | awk -F: '{print $1}')
      if [[ -z "${cfn_templates}" ]]; then
        echo "no cloudformation templates found" >&2
        exit 1
      fi
      cfn_nag ${cfn_templates}
    displayName: Check cloudformation templates

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: infrastructure'
    inputs:
      PathtoPublish: infrastructure
      ArtifactName: infrastructure
